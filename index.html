<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TK COIN</title>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #0044cc; /* Deep Blue */
            --primary-light: #4da6ff;
            --bg-color: #f4f7fa;
            --card-bg: #ffffff;
            --text-dark: #333333;
            --text-light: #888888;
            --danger: #ff4d4d;
            --success: #00cc66;
            --pro-gold: #ffd700;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-dark); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- Utilities --- */
        .hidden { display: none !important; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; width: 100%; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:active { background: #003399; }
        .btn-outline { border: 2px solid var(--primary); background: transparent; color: var(--primary); }
        .btn-danger { background: var(--danger); color: white; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; font-size: 0.9rem; color: var(--text-light); }
        .input-group input, .input-group select, .input-group textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
        
        /* --- Auth Screen --- */
        #auth-screen { flex: 1; display: flex; justify-content: center; align-items: center; padding: 20px; background: linear-gradient(135deg, var(--primary), #002266); }
        .auth-card { background: white; padding: 30px; border-radius: 15px; width: 100%; max-width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center; }
        .auth-card h1 { color: var(--primary); margin-bottom: 20px; }
        .auth-toggle { margin-top: 15px; font-size: 0.9rem; color: var(--primary); cursor: pointer; }

        /* --- Main App Layout --- */
        #app-screen { flex: 1; display: flex; flex-direction: column; height: 100%; position: relative; }
        
        /* Header */
        header { background: var(--primary); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 10; }
        .logo { font-size: 1.2rem; font-weight: bold; display: flex; align-items: center; gap: 8px; }
        .user-balance-display { font-size: 0.9rem; background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 20px; cursor: pointer; }
        
        /* Content Area */
        main { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 80px; } /* padding-bottom for nav */
        
        /* Views */
        .view-section { animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Cards */
        .card { background: var(--card-bg); padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .card h3 { margin-bottom: 10px; color: var(--primary); font-size: 1.1rem; }
        
        /* Market Section */
        .rate-display { font-size: 2rem; font-weight: bold; text-align: center; margin: 20px 0; color: var(--text-dark); }
        .rate-display span { font-size: 1rem; color: var(--text-light); }
        .market-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        /* Feed Section */
        .post-card { border-left: 4px solid var(--primary-light); }
        .post-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .post-user { font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .badge-pro { background: var(--pro-gold); color: #000; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .badge-blue { color: var(--primary); margin-left: 2px; }
        .post-content { margin-bottom: 10px; line-height: 1.5; }
        .post-actions { display: flex; gap: 15px; color: var(--text-light); font-size: 0.9rem; border-top: 1px solid #eee; padding-top: 8px; }
        .post-actions span { cursor: pointer; }
        .post-actions span:hover { color: var(--primary); }

        /* Wallet Section */
        .wallet-tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .wallet-tab { flex: 1; padding: 10px; text-align: center; background: #e0e0e0; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .wallet-tab.active { background: var(--primary); color: white; }
        
        .deposit-info { background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center; border: 1px dashed var(--primary); margin-bottom: 15px; }
        .deposit-number { font-size: 1.2rem; font-weight: bold; color: var(--primary); margin: 10px 0; display: flex; justify-content: center; align-items: center; gap: 10px; }

        .withdraw-calc { background: #fff8e1; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 0.9rem; }
        .withdraw-calc strong { color: var(--danger); }

        /* Profile */
        .profile-header { text-align: center; margin-bottom: 20px; }
        .avatar { width: 80px; height: 80px; background: #ddd; border-radius: 50%; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: white; background: var(--primary-light); }
        .pro-upgrade { background: linear-gradient(45deg, var(--pro-gold), #ffaa00); color: white; padding: 15px; border-radius: 10px; text-align: center; margin-bottom: 15px; cursor: pointer; box-shadow: 0 4px 10px rgba(255, 215, 0, 0.4); }
        
        /* Admin Panel */
        .admin-stat { display: flex; justify-content: space-between; padding: 10px; background: #eee; margin-bottom: 5px; border-radius: 5px; }
        .transaction-item { border-bottom: 1px solid #eee; padding: 10px 0; display: flex; justify-content: space-between; align-items: center; }
        .trans-actions { display: flex; gap: 5px; }
        .trans-actions button { padding: 5px 10px; font-size: 0.8rem; width: auto; }

        /* Bottom Nav */
        nav { position: absolute; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #eee; display: flex; justify-content: space-around; padding: 10px 0; z-index: 20; }
        .nav-item { text-align: center; color: var(--text-light); font-size: 0.8rem; cursor: pointer; flex: 1; }
        .nav-item i { font-size: 1.2rem; margin-bottom: 3px; display: block; }
        .nav-item.active { color: var(--primary); }

        /* Toast Notification */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 350px; }
        .toast { padding: 12px 20px; border-radius: 8px; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: slideDown 0.3s; font-size: 0.9rem; text-align: center; }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    </style>
</head>
<body>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Auth Screen -->
    <div id="auth-screen">
        <div class="auth-card">
            <h1>TK COIN</h1>
            <div id="login-form">
                <div class="input-group">
                    <input type="email" id="login-email" placeholder="Email Address">
                </div>
                <div class="input-group">
                    <input type="password" id="login-pass" placeholder="Password">
                </div>
                <button class="btn btn-primary" onclick="login()">Login</button>
                <div class="auth-toggle" onclick="toggleAuth('register')">Create an Account</div>
            </div>
            <div id="register-form" class="hidden">
                <div class="input-group">
                    <input type="text" id="reg-name" placeholder="Full Name">
                </div>
                <div class="input-group">
                    <input type="email" id="reg-email" placeholder="Email Address">
                </div>
                <div class="input-group">
                    <input type="password" id="reg-pass" placeholder="Password">
                </div>
                <button class="btn btn-primary" onclick="register()">Sign Up</button>
                <div class="auth-toggle" onclick="toggleAuth('login')">Back to Login</div>
            </div>
        </div>
    </div>

    <!-- App Screen -->
    <div id="app-screen" class="hidden">
        <header>
            <div class="logo"><i class="fas fa-coins"></i> TK COIN</div>
            <div class="user-balance-display" onclick="navTo('profile')">
                <span id="header-balance">0.00</span> TK
            </div>
        </header>

        <main id="main-content">
            <!-- Views will be injected here -->
        </main>

        <nav>
            <div class="nav-item active" onclick="navTo('feed')">
                <i class="fas fa-home"></i> Feed
            </div>
            <div class="nav-item" onclick="navTo('market')">
                <i class="fas fa-chart-line"></i> Market
            </div>
            <div class="nav-item" onclick="navTo('wallet')">
                <i class="fas fa-wallet"></i> Wallet
            </div>
            <div class="nav-item" onclick="navTo('profile')">
                <i class="fas fa-user"></i> Profile
            </div>
            <div class="nav-item hidden" id="admin-nav-item" onclick="navTo('admin')">
                <i class="fas fa-cog"></i> Admin
            </div>
        </nav>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyB7atEHWnOo_EzCuFxBRg4xWF51x4atfRQ",
            authDomain: "wingo-new-pro.firebaseapp.com",
            databaseURL: "https://wingo-new-pro-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "wingo-new-pro",
            storageBucket: "wingo-new-pro.firebasestorage.app",
            messagingSenderId: "574707809146",
            appId: "1:574707809146:web:fb0d53fc0a202c4d2934c3",
            measurementId: "G-WED3TVXE62"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // --- STATE MANAGEMENT ---
        let currentUser = null;
        let userData = null; // { balance, isPro, ... }
        let appSettings = {
            coinRate: 25, // Default fallback
            depositNumber: "0300-1234567"
        };
        let currentView = 'feed';

        // --- AUTH LOGIC ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                checkUserRole();
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                showToast(`Welcome back, ${user.email}`, 'success');
            } else {
                currentUser = null;
                userData = null;
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
            }
        });

        function toggleAuth(screen) {
            if(screen === 'register') {
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('register-form').classList.remove('hidden');
            } else {
                document.getElementById('register-form').classList.add('hidden');
                document.getElementById('login-form').classList.remove('hidden');
            }
        }

        function login() {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            if(!email || !pass) return showToast('Please fill all fields', 'error');
            
            auth.signInWithEmailAndPassword(email, pass).catch(e => showToast(e.message, 'error'));
        }

        function register() {
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-pass').value;
            if(!name || !email || !pass) return showToast('Please fill all fields', 'error');

            auth.createUserWithEmailAndPassword(email, pass)
                .then(cred => {
                    // Create user data entry
                    return db.ref('users/' + cred.user.uid).set({
                        name: name,
                        email: email,
                        balance: 0,
                        isPro: false,
                        role: email.includes('admin') ? 'admin' : 'user',
                        averageBuyRate: 0, // Track for instant withdraw
                        totalCoinsHeld: 0
                    });
                })
                .catch(e => showToast(e.message, 'error'));
        }

        function checkUserRole() {
            db.ref('users/' + currentUser.uid).on('value', snapshot => {
                userData = snapshot.val();
                if(!userData) return; // Wait for creation
                
                updateUIHeader();
                
                if(userData.role === 'admin') {
                    document.getElementById('admin-nav-item').classList.remove('hidden');
                } else {
                    document.getElementById('admin-nav-item').classList.add('hidden');
                }

                // Re-render current view if needed to update permissions
                renderView(currentView); 
            });
        }

        // --- GLOBAL LISTENERS ---
        db.ref('settings').on('value', snap => {
            const val = snap.val();
            if(val) {
                appSettings = val;
                if(currentView === 'market' || currentView === 'wallet') renderView(currentView);
            }
        });

        db.ref('posts').orderByChild('timestamp').on('value', snap => {
            if(currentView === 'feed' || currentView === 'admin') renderView(currentView);
        });

        db.ref('transactions').orderByChild('timestamp').on('value', snap => {
            if(currentView === 'wallet' || currentView === 'admin') renderView(currentView);
        });

        // --- NAVIGATION ---
        function navTo(viewName) {
            currentView = viewName;
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            // Very simple selector match based on onclick attribute text
            const navItems = document.querySelectorAll('.nav-item');
            if(viewName === 'feed') navItems[0].classList.add('active');
            if(viewName === 'market') navItems[1].classList.add('active');
            if(viewName === 'wallet') navItems[2].classList.add('active');
            if(viewName === 'profile') navItems[3].classList.add('active');
            if(viewName === 'admin') navItems[4].classList.add('active');

            renderView(viewName);
        }

        function updateUIHeader() {
            if(userData) {
                document.getElementById('header-balance').innerText = userData.balance.toFixed(2);
            }
        }

        // --- RENDERING VIEWS ---
        function renderView(view) {
            const main = document.getElementById('main-content');
            main.innerHTML = ''; // Clear

            if (view === 'feed') renderFeed(main);
            else if (view === 'market') renderMarket(main);
            else if (view === 'wallet') renderWallet(main);
            else if (view === 'profile') renderProfile(main);
            else if (view === 'admin' && userData.role === 'admin') renderAdmin(main);
        }

        // 1. FEED LOGIC
        function renderFeed(container) {
            // Post Creator
            const today = new Date().toDateString();
            const lastPostDate = userData.lastPostDate ? new Date(userData.lastPostDate).toDateString() : null;
            
            const canPost = userData.isPro || lastPostDate !== today;

            let html = `
                <div class="card">
                    <div class="input-group">
                        <textarea id="post-content" rows="3" placeholder="What's on your mind?"></textarea>
                    </div>
                    ${!canPost ? '<p style="color:red; font-size:0.8rem; margin-bottom:10px;">Normal users can post only 1 time per day. Upgrade to Pro!</p>' : ''}
                    <button class="btn btn-primary" onclick="createPost()" ${!canPost ? 'disabled' : ''}>Post Update</button>
                </div>
                <div id="feed-list">
                    <!-- Posts go here -->
                </div>
            `;
            container.innerHTML = html;

            // Fetch Posts
            db.ref('posts').once('value', snap => {
                const list = document.getElementById('feed-list');
                if(!snap.exists()) {
                    list.innerHTML = '<p style="text-align:center; padding:20px;">No posts yet.</p>';
                    return;
                }

                let postsArray = [];
                snap.forEach(child => postsArray.push({...child.val(), id: child.key}));
                postsArray.reverse(); // Newest first

                // Filter: Normal users see only 3 latest
                const limit = userData.isPro ? postsArray.length : 3;
                const visiblePosts = postsArray.slice(0, limit);

                visiblePosts.forEach(post => {
                    const el = document.createElement('div');
                    el.className = 'card post-card';
                    el.innerHTML = `
                        <div class="post-header">
                            <div class="post-user">
                                ${post.authorName}
                                ${post.authorIsPro ? '<span class="badge-pro">PRO</span><i class="fas fa-check-circle badge-blue"></i>' : ''}
                            </div>
                            <div style="font-size:0.8rem; color:#888;">${new Date(post.timestamp).toLocaleTimeString()}</div>
                        </div>
                        <div class="post-content">${post.content}</div>
                        <div class="post-actions">
                            <span onclick="likePost('${post.id}')"><i class="far fa-heart"></i> ${post.likes || 0} Likes</span>
                            <span><i class="far fa-comment"></i> Comment</span>
                            ${userData.role === 'admin' ? `<span style="color:var(--danger); margin-left:auto;" onclick="deletePost('${post.id}')"><i class="fas fa-trash"></i> Remove</span>` : ''}
                        </div>
                        <div style="margin-top:10px; font-size:0.85rem;">
                            <strong>Comments:</strong> ${post.comments ? JSON.stringify(post.comments) : 'No comments yet'}
                        </div>
                    `;
                    list.appendChild(el);
                });

                if (!userData.isPro && postsArray.length > 3) {
                    const moreMsg = document.createElement('div');
                    moreMsg.style.textAlign = 'center';
                    moreMsg.style.color = 'var(--primary)';
                    moreMsg.style.padding = '10px';
                    moreMsg.innerHTML = '<i>Upgrade to PRO to see all posts</i>';
                    list.appendChild(moreMsg);
                }
            });
        }

        function createPost() {
            const content = document.getElementById('post-content').value;
            if(!content) return showToast('Write something first', 'error');

            const newPost = {
                content: content,
                authorId: currentUser.uid,
                authorName: userData.name,
                authorIsPro: userData.isPro,
                timestamp: Date.now(),
                likes: 0
            };

            db.ref('posts').push(newPost).then(() => {
                // Update user last post date
                const updateData = { lastPostDate: Date.now() };
                db.ref('users/' + currentUser.uid).update(updateData);
                showToast('Posted successfully!', 'success');
            });
        }

        function deletePost(id) {
            if(confirm("Admin: Delete this post?")) {
                db.ref('posts/'+id).remove();
                showToast('Post removed', 'success');
            }
        }
        
        function likePost(id) {
            // Simplified like: just increments counter
            db.ref('posts/'+id).transaction(post => {
                if (post) { post.likes = (post.likes || 0) + 1; }
                return post;
            });
        }

        // 2. MARKET LOGIC
        function renderMarket(container) {
            container.innerHTML = `
                <div class="card">
                    <h3>Current Rate</h3>
                    <div class="rate-display">
                        ${appSettings.coinRate} <span>PKR</span>
                    </div>
                    <p style="text-align:center; color:#666;">1 TK COIN = ${appSettings.coinRate} PKR</p>
                </div>

                <div class="card">
                    <h3>Buy TK COIN</h3>
                    <div class="input-group">
                        <label>Amount (PKR)</label>
                        <input type="number" id="buy-pkr" placeholder="Enter PKR amount" oninput="calcBuyCoins()">
                    </div>
                    <p style="margin-bottom:10px;">You will get: <strong id="buy-coin-display">0</strong> TK</p>
                    <div class="input-group">
                        <label>Payment Method</label>
                        <select id="buy-method">
                            <option value="Easypaisa">Easypaisa</option>
                            <option value="JazzCash">JazzCash</option>
                            <option value="Binance">Binance</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="requestBuy()">Buy Now</button>
                </div>

                <div class="card">
                    <h3>Sell TK COIN</h3>
                    <div class="input-group">
                        <label>Amount (TK COIN)</label>
                        <input type="number" id="sell-coin" placeholder="Enter Coins" oninput="calcSellPKR()">
                    </div>
                    <p style="margin-bottom:10px;">You will get: <strong id="sell-pkr-display">0</strong> PKR</p>
                    <div class="input-group">
                        <label>Receive Method</label>
                        <select id="sell-method">
                            <option value="Easypaisa">Easypaisa</option>
                            <option value="JazzCash">JazzCash</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                        </select>
                    </div>
                    <button class="btn btn-danger" onclick="requestSell()">Sell Now</button>
                </div>
            `;
        }

        function calcBuyCoins() {
            const pkr = parseFloat(document.getElementById('buy-pkr').value) || 0;
            const coins = pkr / appSettings.coinRate;
            document.getElementById('buy-coin-display').innerText = coins.toFixed(2);
        }

        function calcSellPKR() {
            const coins = parseFloat(document.getElementById('sell-coin').value) || 0;
            const pkr = coins * appSettings.coinRate;
            document.getElementById('sell-pkr-display').innerText = pkr.toFixed(0);
        }

        function requestBuy() {
            const pkr = parseFloat(document.getElementById('buy-pkr').value);
            const coins = pkr / appSettings.coinRate;
            const method = document.getElementById('buy-method').value;

            if(!pkr || pkr <= 0) return showToast("Invalid amount", "error");

            const transData = {
                userId: currentUser.uid,
                userEmail: userData.email,
                type: 'deposit_buy',
                amountPKR: pkr,
                amountCoin: coins,
                method: method,
                status: 'pending',
                timestamp: Date.now()
            };

            db.ref('transactions').push(transData);
            showToast("Deposit Request Sent to Admin!", "success");
        }

        function requestSell() {
            const coins = parseFloat(document.getElementById('sell-coin').value);
            if(coins > userData.balance) return showToast("Insufficient Balance", "error");

            const pkr = coins * appSettings.coinRate;
            const method = document.getElementById('sell-method').value;

            const transData = {
                userId: currentUser.uid,
                userEmail: userData.email,
                type: 'withdraw_sell',
                amountPKR: pkr,
                amountCoin: coins,
                method: method,
                status: 'pending',
                timestamp: Date.now()
            };

            db.ref('transactions').push(transData).then(() => {
                // Deduct balance immediately (held state logic)
                db.ref('users/' + currentUser.uid).transaction(u => {
                    if(u) {
                        u.balance = parseFloat(u.balance) - coins;
                        // Adjust average buy rate (simplified logic: if selling, we don't change avg much for this demo)
                    }
                    return u;
                });
            });
            showToast("Withdraw Request Sent!", "success");
        }

        // 3. WALLET LOGIC (Withdraw & Hold)
        function renderWallet(container) {
            container.innerHTML = `
                <div class="card">
                    <h3>Wallet Balance</h3>
                    <div class="rate-display" style="color:var(--primary);">${userData.balance.toFixed(2)} TK</div>
                    <div style="text-align:center;">≈ ${(userData.balance * appSettings.coinRate).toFixed(0)} PKR</div>
                </div>

                <div class="wallet-tabs">
                    <div class="wallet-tab active" onclick="switchWalletTab('deposit')">Deposit</div>
                    <div class="wallet-tab" onclick="switchWalletTab('withdraw')">Withdraw</div>
                </div>

                <div id="wallet-content">
                    <!-- Content injected by switchWalletTab -->
                </div>

                <div class="card">
                    <h3>History</h3>
                    <div id="tx-history"></div>
                </div>
            `;
            switchWalletTab('deposit');
            renderTxHistory();
        }

        function switchWalletTab(tab) {
            document.querySelectorAll('.wallet-tab').forEach(t => t.classList.remove('active'));
            if(tab === 'deposit') document.querySelectorAll('.wallet-tab')[0].classList.add('active');
            else document.querySelectorAll('.wallet-tab')[1].classList.add('active');

            const content = document.getElementById('wallet-content');
            
            if (tab === 'deposit') {
                content.innerHTML = `
                    <div class="deposit-info">
                        <p>Send money to this number:</p>
                        <div class="deposit-number">
                            ${appSettings.depositNumber} 
                            <i class="far fa-copy" onclick="copyToClip('${appSettings.depositNumber}')" style="cursor:pointer; color:var(--primary);"></i>
                        </div>
                        <p style="font-size:0.8rem;">After sending, request admin to add coins.</p>
                    </div>
                    <div class="input-group">
                        <label>Transaction ID / Reference</label>
                        <input type="text" id="dep-ref" placeholder="TRX ID">
                    </div>
                    <div class="input-group">
                        <label>Amount Sent (PKR)</label>
                        <input type="number" id="dep-amount" placeholder="Amount">
                    </div>
                    <button class="btn btn-primary" onclick="submitDeposit()">Submit Deposit Request</button>
                `;
            } else {
                // WITHDRAW LOGIC
                content.innerHTML = `
                    <div class="card">
                        <h3>Withdraw Options</h3>
                        
                        <div class="input-group">
                            <label>Coins to Withdraw</label>
                            <input type="number" id="with-amount" placeholder="e.g. 10" oninput="calcWithdraw()">
                        </div>

                        <div class="input-group">
                            <label>Withdrawal Type</label>
                            <select id="with-type" onchange="calcWithdraw()">
                                <option value="instant">Instant Withdraw</option>
                                <option value="hold_1">Hold 1 Day</option>
                                <option value="hold_7">Hold 7 Days</option>
                                <option value="hold_10">Hold 10 Days</option>
                            </select>
                        </div>

                        <div class="withdraw-calc">
                            <p>Rate Used: <span id="calc-rate">0</span> PKR</p>
                            <p>Estimated PKR: <span id="calc-pkr">0</span></p>
                            ${!userData.isPro ? '<p style="color:var(--danger);">Tax (Instant): 3%</p>' : '<p style="color:var(--success);">Pro User: 0% Tax</p>'}
                            <p><strong>You Receive: <span id="calc-final">0</span> PKR</strong></p>
                        </div>

                        <button class="btn btn-primary" onclick="submitWithdraw()">Request Withdrawal</button>
                    </div>
                `;
            }
        }

        function calcWithdraw() {
            const coins = parseFloat(document.getElementById('with-amount').value) || 0;
            const type = document.getElementById('with-type').value;
            let rate = 0;
            let tax = 0;
            let explanation = "";

            // Logic: 
            // Instant = Use Average Buy Price (userData.averageBuyRate). Normal +3% Tax. Pro 0% Tax.
            // Hold = Use Current Market Price (appSettings.coinRate). 0% Tax.

            if (type === 'instant') {
                rate = userData.averageBuyRate || appSettings.coinRate; // Fallback if avg is 0
                if (!userData.isPro) tax = 0.03;
                explanation = "Based on your Buy Price (Instant)";
            } else {
                rate = appSettings.coinRate;
                tax = 0;
                explanation = "Based on Current Market Rate (Hold)";
            }

            const grossPKR = coins * rate;
            const finalPKR = grossPKR * (1 - tax);

            document.getElementById('calc-rate').innerText = rate.toFixed(2);
            document.getElementById('calc-pkr').innerText = grossPKR.toFixed(0);
            document.getElementById('calc-final').innerText = finalPKR.toFixed(0);
        }

        function submitDeposit() {
            const ref = document.getElementById('dep-ref').value;
            const amt = document.getElementById('dep-amount').value;
            if(!ref || !amt) return showToast("Fill all details", "error");

            db.ref('transactions').push({
                userId: currentUser.uid,
                userEmail: userData.email,
                type: 'deposit_funds',
                amountPKR: parseFloat(amt),
                details: ref,
                status: 'pending',
                timestamp: Date.now()
            });
            showToast("Deposit request sent", "success");
            navTo('wallet');
        }

        function submitWithdraw() {
            const coins = parseFloat(document.getElementById('with-amount').value);
            const type = document.getElementById('with-type').value; // instant, hold_1, hold_7, hold_10
            
            if(coins > userData.balance) return showToast("Insufficient Balance", "error");

            // Determine release time
            let releaseTime = Date.now(); // Instant default
            if(type === 'hold_1') releaseTime += (24 * 60 * 60 * 1000);
            if(type === 'hold_7') releaseTime += (7 * 24 * 60 * 60 * 1000);
            if(type === 'hold_10') releaseTime += (10 * 24 * 60 * 60 * 1000);

            // Re-calculate values for DB record
            let rate = (type === 'instant') ? (userData.averageBuyRate || appSettings.coinRate) : appSettings.coinRate;
            let tax = (!userData.isPro && type === 'instant') ? 0.03 : 0;
            let pkr = coins * rate * (1 - tax);

            db.ref('users/' + currentUser.uid).transaction(u => {
                if(u) u.balance -= coins;
                return u;
            }).then(() => {
                db.ref('transactions').push({
                    userId: currentUser.uid,
                    userEmail: userData.email,
                    type: 'withdraw',
                    amountCoin: coins,
                    amountPKR: pkr,
                    rateUsed: rate,
                    method: type, // instant or hold_X
                    releaseDate: releaseTime,
                    status: type === 'instant' ? 'pending' : 'held', // Instant needs admin approve, Held is locked
                    timestamp: Date.now()
                });
                showToast("Withdraw request created", "success");
                navTo('wallet');
            });
        }

        function renderTxHistory() {
            db.ref('transactions').orderByChild('userId').equalTo(currentUser.uid).once('value', snap => {
                const list = document.getElementById('tx-history');
                list.innerHTML = '';
                if(!snap.exists()) { list.innerHTML = '<p style="font-size:0.8rem">No history</p>'; return; }
                
                snap.forEach(child => {
                    const t = child.val();
                    const div = document.createElement('div');
                    div.style.borderBottom = '1px solid #eee';
                    div.style.padding = '8px 0';
                    div.style.fontSize = '0.85rem';
                    
                    let color = t.status === 'approved' ? 'green' : (t.status === 'rejected' ? 'red' : 'orange');
                    
                    div.innerHTML = `
                        <div style="display:flex; justify-content:space-between;">
                            <span style="font-weight:bold; text-transform:uppercase;">${t.type}</span>
                            <span style="color:${color}">${t.status}</span>
                        </div>
                        <div>${new Date(t.timestamp).toLocaleDateString()}</div>
                    `;
                    list.prepend(div); // Newest top
                });
            });
        }

        // 4. PROFILE LOGIC
        function renderProfile(container) {
            container.innerHTML = `
                <div class="profile-header">
                    <div class="avatar">
                        ${userData.isPro ? '<i class="fas fa-crown"></i>' : '<i class="fas fa-user"></i>'}
                    </div>
                    <h2>${userData.name} ${userData.isPro ? '<i class="fas fa-check-circle" style="color:var(--primary)"></i>' : ''}</h2>
                    <p>${currentUser.email}</p>
                </div>

                ${!userData.isPro ? `
                <div class="pro-upgrade" onclick="buyPro()">
                    <h3><i class="fas fa-crown"></i> Upgrade to PRO</h3>
                    <p>Get 0% Tax, Unlimited Posts, Verified Badge & Full Feed Access!</p>
                    <button class="btn" style="background:white; color:var(--pro-gold); margin-top:10px;">Buy Now</button>
                </div>
                ` : `
                <div class="card" style="text-align:center; background: #fff8e1; border: 1px solid var(--pro-gold);">
                    <h3 style="color:var(--pro-gold);">PRO MEMBER</h3>
                    <p>You have exclusive access to all features.</p>
                </div>
                `}

                <div class="card">
                    <div class="admin-stat">
                        <span>Total Coins</span>
                        <strong>${userData.balance.toFixed(2)} TK</strong>
                    </div>
                    <div class="admin-stat">
                        <span>Value in PKR</span>
                        <strong>${(userData.balance * appSettings.coinRate).toFixed(0)} PKR</strong>
                    </div>
                    <div class="admin-stat">
                        <span>Avg Buy Rate</span>
                        <strong>${userData.averageBuyRate ? userData.averageBuyRate.toFixed(2) : 0} PKR</strong>
                    </div>
                </div>

                <button class="btn btn-danger" onclick="logout()">Logout</button>
            `;
        }

        function buyPro() {
            if(confirm("Purchase PRO membership for 500 TK Coins?")) {
                if(userData.balance >= 500) {
                    db.ref('users/'+currentUser.uid).transaction(u => {
                        if(u) {
                            u.balance -= 500;
                            u.isPro = true;
                        }
                        return u;
                    }).then(() => showToast("Upgraded to PRO!", "success"));
                } else {
                    showToast("Insufficient Balance", "error");
                }
            }
        }

        function logout() {
            auth.signOut();
            window.location.reload();
        }

        // 5. ADMIN LOGIC
        function renderAdmin(container) {
            container.innerHTML = `
                <div class="card">
                    <h3>Admin Settings</h3>
                    <div class="input-group">
                        <label>Coin Rate (PKR)</label>
                        <input type="number" id="admin-rate" value="${appSettings.coinRate}">
                    </div>
                    <div class="input-group">
                        <label>Deposit Number</label>
                        <input type="text" id="admin-dep-num" value="${appSettings.depositNumber}">
                    </div>
                    <button class="btn btn-primary" onclick="updateAdminSettings()">Update Settings</button>
                </div>

                <div class="card">
                    <h3>Pending Transactions</h3>
                    <div id="admin-tx-list"></div>
                </div>
            `;
            renderAdminTxList();
        }

        function updateAdminSettings() {
            const rate = parseFloat(document.getElementById('admin-rate').value);
            const num = document.getElementById('admin-dep-num').value;
            db.ref('settings').update({
                coinRate: rate,
                depositNumber: num
            }).then(() => showToast("Settings Updated", "success"));
        }

        function renderAdminTxList() {
            db.ref('transactions').orderByChild('status').equalTo('pending').once('value', snap => {
                const list = document.getElementById('admin-tx-list');
                list.innerHTML = '';
                if(!snap.exists()) { list.innerHTML = '<p>No pending transactions</p>'; return; }

                snap.forEach(child => {
                    const t = child.val();
                    const div = document.createElement('div');
                    div.className = 'transaction-item';
                    div.innerHTML = `
                        <div>
                            <div style="font-weight:bold;">${t.userEmail}</div>
                            <div style="font-size:0.8rem;">${t.type} | ${t.amountCoin ? t.amountCoin.toFixed(2) : '-'} TK / ${t.amountPKR ? t.amountPKR.toFixed(0) : '-'} PKR</div>
                        </div>
                        <div class="trans-actions">
                            <button class="btn btn-success" style="background:var(--success); width:auto;" onclick="processTx('${child.key}', 'approve', ${t.amountCoin || 0}, ${t.amountPKR || 0}, '${t.type}')">✔</button>
                            <button class="btn btn-danger" style="background:var(--danger); width:auto;" onclick="processTx('${child.key}', 'reject', ${t.amountCoin || 0}, ${t.amountPKR || 0}, '${t.type}')">✖</button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            });
        }

        function processTx(key, action, coins, pkr, type) {
            const txRef = db.ref('transactions/' + key);
            
            if (action === 'reject') {
                // Refund coins if it was a sell/withdraw
                if (type.includes('withdraw') || type.includes('sell')) {
                    db.ref('users').orderByChild('email').equalTo('...').once('value', uSnap => {
                        // Simplified: We need userId. In real app, store userId in tx (which I did).
                        txRef.once('value', s => {
                            const uid = s.val().userId;
                            db.ref('users/'+uid).transaction(user => {
                                if(user) user.balance = parseFloat(user.balance) + coins;
                                return user;
                            });
                        });
                    });
                }
                txRef.update({ status: 'rejected' });
                showToast("Rejected", "error");

            } else if (action === 'approve') {
                // If Deposit/Buy: Add coins to user
                if (type.includes('deposit') || type.includes('buy')) {
                    txRef.once('value', s => {
                        const uid = s.val().userId;
                        const coinAmt = s.val().amountCoin;
                        
                        // Update Balance
                        db.ref('users/'+uid).transaction(user => {
                            if(user) {
                                user.balance = parseFloat(user.balance) + coinAmt;
                                
                                // Update Average Buy Rate logic: (OldTotal*OldAvg + NewAmt*CurrentRate) / NewTotal
                                const oldTotal = parseFloat(user.totalCoinsHeld || user.balance); // Approximation
                                const oldAvg = user.averageBuyRate || 0;
                                const currentRate = appSettings.coinRate;
                                
                                // Simplification for this demo: Weighted average
                                const totalVal = (oldTotal * oldAvg) + (coinAmt * currentRate);
                                const newTotal = oldTotal + coinAmt;
                                user.averageBuyRate = newTotal > 0 ? totalVal / newTotal : currentRate;
                            }
                            return user;
                        });
                    });
                }
                // If Withdraw/Sell: Admin manually sends money (Simulated here just by marking approved)
                
                txRef.update({ status: 'approved' });
                showToast("Approved", "success");
            }
        }

        // --- UTILS ---
        function copyToClip(text) {
            navigator.clipboard.writeText(text);
            showToast("Copied to clipboard", "success");
        }

        function showToast(msg, type) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerText = msg;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

    </script>
</body>
</html>
