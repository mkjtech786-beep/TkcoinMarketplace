<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TK COIN</title>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        :root {
            --primary: #FF6F00; /* Orange */
            --primary-dark: #E65100;
            --secondary: #2D2D2D;
            --bg: #121212;
            --card: #1E1E1E;
            --text: #FFFFFF;
            --text-muted: #B0B0B0;
            --success: #00C853;
            --danger: #FF1744;
            --border: #333;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        
        body { background-color: var(--bg); color: var(--text); padding-bottom: 70px; }
        
        /* Helpers */
        .hidden { display: none !important; }
        .text-orange { color: var(--primary); }
        .text-success { color: var(--success); }
        .btn {
            background: var(--primary); color: white; border: none; padding: 10px 20px;
            border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%; transition: 0.2s;
        }
        .btn:hover { background: var(--primary-dark); }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-danger { background: var(--danger); }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; width: auto; }

        /* Inputs */
        input, select, textarea {
            width: 100%; background: var(--secondary); border: 1px solid var(--border);
            color: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; outline: none;
        }
        input:focus { border-color: var(--primary); }

        /* Auth Screen */
        #auth-screen {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            height: 100vh; padding: 20px; background: linear-gradient(135deg, #121212 0%, #2a1b05 100%);
        }
        .auth-box { width: 100%; max-width: 400px; background: var(--card); padding: 30px; border-radius: 15px; border-top: 4px solid var(--primary); }
        .logo { font-size: 2rem; font-weight: 800; text-align: center; margin-bottom: 20px; color: var(--primary); }

        /* App Layout */
        header {
            background: var(--card); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--border);
        }
        .nav-bar {
            position: fixed; bottom: 0; width: 100%; background: var(--card); display: flex; justify-content: space-around;
            padding: 15px; border-top: 1px solid var(--border); z-index: 100;
        }
        .nav-item { color: var(--text-muted); text-align: center; font-size: 0.8rem; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 1.2rem; margin-bottom: 4px; display: block; }

        /* Sections */
        .section { padding: 20px; max-width: 600px; margin: 0 auto; }
        
        /* Cards */
        .card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid var(--border); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .card-title { font-weight: 600; color: var(--primary); }
        
        /* Coin Info */
        .rate-display { text-align: center; margin: 20px 0; }
        .current-rate { font-size: 2.5rem; font-weight: 700; color: var(--success); }
        .rate-label { color: var(--text-muted); }

        /* Feed */
        .post { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .post-header { display: flex; align-items: center; margin-bottom: 10px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--border); margin-right: 10px; display: flex; align-items: center; justify-content: center; overflow: hidden;}
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        .user-info h4 { font-size: 0.9rem; }
        .badge-verify { color: #1DA1F2; margin-left: 5px; font-size: 0.8rem; }
        .badge-pro { background: var(--primary); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; margin-left: 5px; }
        .post-actions { display: flex; gap: 20px; margin-top: 10px; color: var(--text-muted); font-size: 0.9rem; }
        .action-item { cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .action-item:hover { color: var(--primary); }

        /* Admin Badge in Nav */
        .admin-indicator { position: absolute; top: -5px; right: -5px; background: var(--danger); width: 10px; height: 10px; border-radius: 50%; }

        /* Toast */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 1000; }
        .toast { background: var(--card); color: white; padding: 12px 20px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid var(--primary); animation: slideIn 0.3s; display: flex; align-items: center; justify-content: space-between; min-width: 250px; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* Loading */
        .loader { border: 3px solid rgba(255,255,255,0.1); border-radius: 50%; border-top: 3px solid var(--primary); width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Tables */
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid var(--border); }
        th { color: var(--primary); }
    </style>
</head>
<body>

    <!-- Toast Notifications -->
    <div id="toast-container"></div>

    <!-- AUTHENTICATION -->
    <div id="auth-screen">
        <div class="auth-box">
            <div class="logo">TK COIN</div>
            <div id="login-form">
                <h3>Login</h3>
                <p style="color:var(--text-muted); margin-bottom:15px; font-size:0.9rem;">Welcome back to TK Coin.</p>
                <input type="email" id="login-email" placeholder="Email">
                <input type="password" id="login-pass" placeholder="Password">
                <button class="btn" onclick="login()">Login</button>
                <p style="margin-top:15px; text-align:center; font-size:0.9rem;">
                    Don't have an account? <span class="text-orange" onclick="toggleAuth('signup')" style="cursor:pointer">Sign Up</span>
                </p>
                <p style="margin-top:5px; text-align:center; font-size:0.8rem; color:#555;">(Use admin@tkcoin.com for Admin Panel)</p>
            </div>

            <div id="signup-form" class="hidden">
                <h3>Sign Up</h3>
                <p style="color:var(--text-muted); margin-bottom:15px; font-size:0.9rem;">Create your account to start trading.</p>
                <input type="text" id="signup-name" placeholder="Full Name">
                <input type="email" id="signup-email" placeholder="Email">
                <input type="password" id="signup-pass" placeholder="Password">
                <button class="btn" onclick="signup()">Sign Up</button>
                <p style="margin-top:15px; text-align:center; font-size:0.9rem;">
                    Already have an account? <span class="text-orange" onclick="toggleAuth('login')" style="cursor:pointer">Login</span>
                </p>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app-screen" class="hidden">
        <header>
            <div class="logo" style="font-size:1.5rem; margin:0;">TK COIN</div>
            <div id="header-balance" style="font-size:0.9rem;">
                Loading...
            </div>
        </header>

        <!-- FEED SECTION -->
        <div id="feed-section" class="section">
            <div class="card">
                <textarea id="post-input" rows="3" placeholder="What's on your mind? (Normal: 1 post/day)"></textarea>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span id="post-limit-msg" style="font-size:0.75rem; color:var(--text-muted);"></span>
                    <button class="btn btn-sm" onclick="createPost()">Post</button>
                </div>
            </div>
            <div id="feed-container">
                <!-- Posts go here -->
            </div>
        </div>

        <!-- MARKET SECTION -->
        <div id="market-section" class="section hidden">
            <div class="card rate-display">
                <div class="rate-label">Current Rate (PKR)</div>
                <div class="current-rate" id="market-rate">Loading...</div>
                <div class="rate-label" style="font-size:0.8rem; margin-top:5px;">1 TK COIN = <span id="market-rate-text">0</span> PKR</div>
            </div>

            <!-- Deposit -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Buy / Deposit</span>
                    <i class="fas fa-wallet text-orange"></i>
                </div>
                <p style="font-size:0.85rem; color:var(--text-muted); margin-bottom:10px;">Send money to the number below to buy Coins.</p>
                <div style="background:var(--bg); padding:10px; border-radius:8px; border:1px dashed var(--primary); margin-bottom:10px;">
                    <div style="font-size:0.8rem; color:var(--text-muted);">Deposit Number (EasyPaisa/JazzCash/Binance)</div>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span id="deposit-number-display" style="font-size:1.2rem; font-weight:700;">0300-0000000</span>
                        <i class="far fa-copy text-orange" onclick="copyDepositNumber()" style="cursor:pointer;"></i>
                    </div>
                </div>
                <input type="number" id="deposit-amount" placeholder="Amount in PKR">
                <button class="btn" onclick="requestDeposit()">Submit Deposit Request</button>
            </div>

            <!-- Withdraw -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Sell / Withdraw</span>
                    <i class="fas fa-money-bill-wave text-orange"></i>
                </div>
                <div style="font-size:0.8rem; margin-bottom:10px; color:var(--text-muted);">
                    Your Balance: <span id="withdraw-coins-display" class="text-success">0</span> Coins
                </div>
                
                <label style="font-size:0.8rem; color:var(--text-muted);">Withdraw Type</label>
                <select id="withdraw-type" onchange="updateWithdrawCalc()">
                    <option value="instant">Instant (Tax Applies)</option>
                    <option value="hold">Hold (1, 7, 10 Days)</option>
                </select>

                <div id="hold-options" class="hidden">
                    <label style="font-size:0.8rem; color:var(--text-muted);">Hold Duration</label>
                    <select id="hold-duration" onchange="updateWithdrawCalc()">
                        <option value="1">1 Day</option>
                        <option value="7">7 Days</option>
                        <option value="10">10 Days</option>
                    </select>
                    <p style="font-size:0.75rem; color:var(--text-muted);">* Withdraw at <b>Current Market Rate</b>.</p>
                </div>

                <div id="instant-options">
                    <p style="font-size:0.75rem; color:var(--text-muted);">
                        * Receive at <b>Average Buy Price</b> (No Profit/Loss).
                        <br>* Tax: <span id="tax-rate-display">3%</span>
                    </p>
                </div>

                <input type="number" id="withdraw-amount" placeholder="Coins to Withdraw" oninput="updateWithdrawCalc()">
                
                <div style="background:var(--bg); padding:10px; border-radius:8px; margin-bottom:10px;">
                    <div style="display:flex; justify-content:space-between; font-size:0.9rem;">
                        <span>You Receive (PKR):</span>
                        <span id="withdraw-pkr" class="text-success">0</span>
                    </div>
                </div>

                <button class="btn btn-outline" onclick="requestWithdraw()">Request Withdraw</button>
            </div>
            
            <!-- History -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Transaction History</span>
                </div>
                <div id="history-container" style="max-height:300px; overflow-y:auto;">
                    <!-- History Items -->
                </div>
            </div>
        </div>

        <!-- PROFILE SECTION -->
        <div id="profile-section" class="section hidden">
            <div class="card" style="text-align:center; padding-top:30px;">
                <div class="avatar" style="width:80px; height:80px; margin:0 auto 15px; font-size:2rem;">
                    <i class="fas fa-user"></i>
                </div>
                <h2 id="profile-name">User Name</h2>
                <div id="profile-badges"></div>
                <div style="margin-top:15px;">
                    <div style="font-size:0.9rem; color:var(--text-muted);">Total Balance</div>
                    <div style="font-size:2rem; font-weight:700; color:var(--primary);">
                        <span id="profile-coins">0</span> <span style="font-size:1rem;">TK</span>
                    </div>
                    <div style="font-size:1.2rem; color:var(--success); margin-top:5px;">
                        PKR <span id="profile-pkr">0</span>
                    </div>
                    <div style="font-size:0.8rem; color:var(--text-muted); margin-top:5px;">
                        (Est. based on current rate)
                    </div>
                </div>
            </div>

            <div class="card hidden" id="upgrade-card">
                <div class="card-header">
                    <span class="card-title">Upgrade to PRO</span>
                    <i class="fas fa-crown text-orange"></i>
                </div>
                <ul style="font-size:0.85rem; margin-bottom:15px; padding-left:20px; color:var(--text-muted);">
                    <li>Unlimited Posting</li>
                    <li>0% Withdrawal Tax</li>
                    <li>Verified Blue Tick</li>
                    <li>View All Feed Posts</li>
                </ul>
                <button class="btn" onclick="buyPro()">Buy Pro Features</button>
            </div>

            <button class="btn btn-danger btn-outline" onclick="logout()">Logout</button>
        </div>

        <!-- ADMIN SECTION -->
        <div id="admin-section" class="section hidden">
            <h2 style="margin-bottom:20px; border-bottom:1px solid var(--border); padding-bottom:10px;">Admin Panel</h2>
            
            <!-- Settings -->
            <div class="card">
                <div class="card-header"><span class="card-title">Global Settings</span></div>
                <label>Coin Rate (PKR)</label>
                <input type="number" id="admin-rate">
                <label>Deposit Number</label>
                <input type="text" id="admin-deposit-number">
                <button class="btn" onclick="saveSettings()">Update Settings</button>
            </div>

            <!-- Requests -->
            <div class="card">
                <div class="card-header"><span class="card-title">Requests</span></div>
                <div id="admin-requests" style="max-height:400px; overflow-y:auto;">
                    <!-- Requests List -->
                </div>
            </div>

             <!-- Users -->
             <div class="card">
                <div class="card-header"><span class="card-title">Users</span></div>
                <div id="admin-users" style="max-height:300px; overflow-y:auto;"></div>
            </div>
        </div>

        <!-- NAVIGATION -->
        <nav class="nav-bar">
            <div class="nav-item active" onclick="navTo('feed', this)">
                <i class="fas fa-home"></i> Home
            </div>
            <div class="nav-item" onclick="navTo('market', this)">
                <i class="fas fa-chart-line"></i> Market
            </div>
            <div class="nav-item" onclick="navTo('profile', this)">
                <i class="fas fa-user"></i> Profile
            </div>
            <div class="nav-item hidden" id="nav-admin" onclick="navTo('admin', this)">
                <i class="fas fa-shield-alt"></i> Admin
            </div>
        </nav>
    </div>

    <script>
        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyArw_JZNXKJ_bXdi3yUR1efQ7pAsoaGd4k",
            authDomain: "tkcoin-8281a.firebaseapp.com",
            databaseURL: "https://tkcoin-8281a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "tkcoin-8281a",
            storageBucket: "tkcoin-8281a.firebasestorage.app",
            messagingSenderId: "877042943142",
            appId: "1:877042943142:web:88921ed0f2d567e211e067",
            measurementId: "G-017VEJSHWQ"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- GLOBAL STATE ---
        let currentUser = null;
        let userData = null;
        let globalSettings = { rate: 25, depositNumber: "0300-1234567" };

        // --- AUTH LOGIC ---
        function toggleAuth(screen) {
            if(screen === 'signup') {
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('signup-form').classList.remove('hidden');
            } else {
                document.getElementById('login-form').classList.remove('hidden');
                document.getElementById('signup-form').classList.add('hidden');
            }
        }

        function login() {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            if(!email || !pass) return showToast("Please fill all fields", "error");

            auth.signInWithEmailAndPassword(email, pass)
                .then(() => {
                    showToast("Login Successful");
                })
                .catch(err => showToast(err.message, "error"));
        }

        function signup() {
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const pass = document.getElementById('signup-pass').value;
            if(!name || !email || !pass) return showToast("Please fill all fields", "error");

            auth.createUserWithEmailAndPassword(email, pass)
                .then((cred) => {
                    // Create User Doc
                    return db.collection('users').doc(cred.user.uid).set({
                        name: name,
                        email: email,
                        role: 'user', // Default
                        isPro: false,
                        balanceCoins: 0,
                        totalDepositsPKR: 0, // To calculate average buy price
                        lastPostDate: null,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                })
                .then(() => {
                    showToast("Account Created");
                })
                .catch(err => showToast(err.message, "error"));
        }

        function logout() {
            auth.signOut();
            window.location.reload();
        }

        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                loadUserData();
            } else {
                currentUser = null;
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
            }
        });

        // --- DATA LOADING ---
        function loadUserData() {
            db.collection('users').doc(currentUser.uid).onSnapshot(doc => {
                if(doc.exists) {
                    userData = doc.data();
                    updateProfileUI();
                    updateHeaderUI();
                    
                    // Check if Admin
                    const adminEmail = "admin@tkcoin.com";
                    if (userData.role === 'admin' || currentUser.email === adminEmail) {
                        document.getElementById('nav-admin').classList.remove('hidden');
                        loadAdminData();
                    }
                    
                    loadFeed();
                    loadHistory();
                }
            });

            // Listen to Settings
            db.collection('settings').doc('global').onSnapshot(doc => {
                if(doc.exists) {
                    globalSettings = doc.data();
                    document.getElementById('market-rate').innerText = globalSettings.rate;
                    document.getElementById('market-rate-text').innerText = globalSettings.rate;
                    document.getElementById('deposit-number-display').innerText = globalSettings.depositNumber;
                    
                    // Admin Inputs
                    document.getElementById('admin-rate').value = globalSettings.rate;
                    document.getElementById('admin-deposit-number').value = globalSettings.depositNumber;

                    updateProfileUI(); // Update PKR equivalent
                }
            });
        }

        function updateProfileUI() {
            if(!userData) return;
            
            document.getElementById('profile-name').innerText = userData.name;
            document.getElementById('profile-coins').innerText = userData.balanceCoins;
            document.getElementById('withdraw-coins-display').innerText = userData.balanceCoins;

            // Calculate PKR Equiv
            const pkrEquiv = (userData.balanceCoins * globalSettings.rate).toFixed(2);
            document.getElementById('profile-pkr').innerText = pkrEquiv;

            // Badges & Pro Status
            const badgesContainer = document.getElementById('profile-badges');
            badgesContainer.innerHTML = '';
            
            if(userData.isPro) {
                badgesContainer.innerHTML += `<i class="fas fa-check-circle badge-verify" title="Verified"></i> <span class="badge-pro">PRO</span>`;
                document.getElementById('upgrade-card').classList.add('hidden');
                document.getElementById('tax-rate-display').innerText = "0% (Pro User)";
            } else {
                document.getElementById('upgrade-card').classList.remove('hidden');
                document.getElementById('tax-rate-display').innerText = "3%";
            }
        }

        function updateHeaderUI() {
            const pkrEquiv = (userData.balanceCoins * globalSettings.rate).toFixed(0);
            document.getElementById('header-balance').innerHTML = `
                ${userData.balanceCoins.toFixed(2)} TK <span style="font-size:0.8rem; color:#888;">(~${pkrEquiv} PKR)</span>
            `;
        }

        // --- NAVIGATION ---
        function navTo(section, el) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            // Show target
            document.getElementById(`${section}-section`).classList.remove('hidden');
            
            // Update Nav
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');

            // Refresh specific data
            if(section === 'feed') loadFeed();
            if(section === 'profile') updateProfileUI();
            if(section === 'admin') loadAdminData();
        }

        // --- FEED SYSTEM ---
        function loadFeed() {
            const container = document.getElementById('feed-container');
            container.innerHTML = '<div style="text-align:center; padding:20px;"><div class="loader"></div></div>';

            let query = db.collection('posts').orderBy('timestamp', 'desc');
            
            // Limit logic for Normal Users
            if(!userData.isPro) {
                query = query.limit(3);
            }

            query.get().then(snapshot => {
                container.innerHTML = '';
                if(snapshot.empty) container.innerHTML = '<p style="text-align:center; color:#555;">No posts yet.</p>';

                snapshot.forEach(doc => {
                    const p = doc.data();
                    const isMine = p.uid === currentUser.uid;
                    const isAdmin = userData.role === 'admin' || currentUser.email === 'admin@tkcoin.com';
                    
                    const canDelete = isMine || isAdmin;
                    const deleteBtn = canDelete ? `<i class="fas fa-trash" style="color:var(--danger); cursor:pointer; float:right;" onclick="deletePost('${doc.id}')"></i>` : '';
                    
                    const proBadge = (p.isPro) ? `<i class="fas fa-check-circle badge-verify"></i> <span class="badge-pro">PRO</span>` : '';
                    const likeClass = p.likes && p.likes.includes(currentUser.uid) ? 'text-orange' : '';

                    const html = `
                    <div class="post">
                        ${deleteBtn}
                        <div class="post-header">
                            <div class="avatar"><i class="fas fa-user"></i></div>
                            <div class="user-info">
                                <h4>${p.name} ${proBadge}</h4>
                                <span style="font-size:0.7rem; color:#666;">${new Date(p.timestamp?.toDate()).toLocaleString()}</span>
                            </div>
                        </div>
                        <div style="margin-bottom:10px;">${p.text}</div>
                        <div class="post-actions">
                            <div class="action-item ${likeClass}" onclick="toggleLike('${doc.id}')">
                                <i class="fas fa-heart"></i> ${p.likes ? p.likes.length : 0}
                            </div>
                            <div class="action-item">
                                <i class="fas fa-comment"></i> ${p.comments ? p.comments.length : 0}
                            </div>
                        </div>
                    </div>`;
                    container.innerHTML += html;
                });
            });
        }

        function createPost() {
            if(!userData.isPro) {
                // Check daily limit
                const today = new Date().toDateString();
                if(userData.lastPostDate === today) {
                    return showToast("Normal users can only post 1 time per day. Upgrade to Pro!", "error");
                }
            }

            const text = document.getElementById('post-input').value;
            if(!text.trim()) return showToast("Cannot post empty text", "error");

            db.collection('posts').add({
                uid: currentUser.uid,
                name: userData.name,
                isPro: userData.isPro,
                text: text,
                likes: [],
                comments: [],
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                showToast("Posted successfully");
                document.getElementById('post-input').value = '';
                if(!userData.isPro) {
                    db.collection('users').doc(currentUser.uid).update({ lastPostDate: new Date().toDateString() });
                }
                loadFeed();
            });
        }

        function deletePost(pid) {
            if(confirm("Delete this post?")) {
                db.collection('posts').doc(pid).delete().then(() => {
                    showToast("Post deleted");
                    loadFeed();
                });
            }
        }

        function toggleLike(pid) {
            db.collection('posts').doc(pid).get().then(doc => {
                const likes = doc.data().likes || [];
                if(likes.includes(currentUser.uid)) {
                    // Unlike
                    db.collection('posts').doc(pid).update({
                        likes: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)
                    });
                } else {
                    // Like
                    db.collection('posts').doc(pid).update({
                        likes: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
                    });
                }
                loadFeed(); // Refresh UI
            });
        }

        // --- MARKET & WITHDRAWAL LOGIC ---
        function copyDepositNumber() {
            navigator.clipboard.writeText(globalSettings.depositNumber);
            showToast("Number Copied!");
        }

        function requestDeposit() {
            const amountPKR = parseFloat(document.getElementById('deposit-amount').value);
            if(!amountPKR || amountPKR <= 0) return showToast("Invalid amount", "error");

            db.collection('requests').add({
                uid: currentUser.uid,
                type: 'deposit',
                amountPKR: amountPKR,
                status: 'pending',
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                rateAtRequest: globalSettings.rate
            }).then(() => {
                showToast("Deposit request sent to Admin");
                document.getElementById('deposit-amount').value = '';
                loadHistory();
            });
        }

        function updateWithdrawCalc() {
            const coins = parseFloat(document.getElementById('withdraw-amount').value) || 0;
            const type = document.getElementById('withdraw-type').value;
            const displayEl = document.getElementById('withdraw-pkr');
            
            if(coins > userData.balanceCoins) {
                displayEl.innerText = "Insufficient Balance";
                displayEl.classList.remove('text-success');
                displayEl.classList.add('text-danger');
                return;
            }
            displayEl.classList.add('text-success');
            displayEl.classList.remove('text-danger');

            let rateToUse = 0;
            let finalPKR = 0;

            // Calculate Average Buy Price for user (Total Deposits / Total Coins if coins > 0, else 0)
            const avgBuyPrice = userData.balanceCoins > 0 ? (userData.totalDepositsPKR / userData.balanceCoins) : 0;

            if(type === 'instant') {
                rateToUse = avgBuyPrice; // Prompt: "us ko wohin price mily jis me us ne khareeda tha"
                // Tax Logic: Normal 3%, Pro 0%
                let tax = 0;
                if(!userData.isPro) {
                    tax = finalPKR * 0.03;
                }
                finalPKR = (coins * rateToUse) - tax;
            } else {
                // Hold Logic: Use Current Rate, No Tax
                rateToUse = globalSettings.rate;
                finalPKR = coins * rateToUse;
            }

            displayEl.innerText = finalPKR.toFixed(2) + " PKR";
        }

        function requestWithdraw() {
            const coins = parseFloat(document.getElementById('withdraw-amount').value);
            if(!coins || coins <= 0) return showToast("Invalid amount", "error");
            if(coins > userData.balanceCoins) return showToast("Insufficient Balance", "error");

            const type = document.getElementById('withdraw-type').value;
            const holdDays = (type === 'hold') ? parseInt(document.getElementById('hold-duration').value) : 0;
            
            // Recalculate final amount to be sure
            const avgBuyPrice = (userData.totalDepositsPKR / userData.balanceCoins);
            let rateUsed = (type === 'instant') ? avgBuyPrice : globalSettings.rate;
            let finalPKR = coins * rateUsed;
            if(type === 'instant' && !userData.isPro) finalPKR = finalPKR * 0.97; // 3% tax

            db.collection('requests').add({
                uid: currentUser.uid,
                type: 'withdraw',
                amountCoins: coins,
                amountPKR: finalPKR, // Store calculated PKR
                status: 'pending',
                withdrawType: type,
                holdDays: holdDays,
                rateUsed: rateUsed,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                showToast("Withdrawal request sent");
                document.getElementById('withdraw-amount').value = '';
                loadHistory();
            });
        }

        function loadHistory() {
            db.collection('requests')
            .where('uid', '==', currentUser.uid)
            .orderBy('timestamp', 'desc')
            .limit(10)
            .get()
            .then(snapshot => {
                const container = document.getElementById('history-container');
                container.innerHTML = '';
                snapshot.forEach(doc => {
                    const r = doc.data();
                    let color = r.status === 'approved' ? 'var(--success)' : (r.status === 'rejected' ? 'var(--danger)' : 'var(--primary)');
                    let icon = r.type === 'deposit' ? 'fa-arrow-down' : 'fa-arrow-up';
                    
                    container.innerHTML += `
                    <div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #333;">
                        <div>
                            <div style="font-weight:600;"><i class="fas ${icon}"></i> ${r.type.toUpperCase()}</div>
                            <div style="font-size:0.75rem; color:#888;">${new Date(r.timestamp?.toDate()).toLocaleDateString()}</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-weight:600; color:${color};">${r.status.toUpperCase()}</div>
                            <div style="font-size:0.8rem;">${r.amountCoins ? r.amountCoins.toFixed(2) + ' TK' : r.amountPKR + ' PKR'}</div>
                        </div>
                    </div>`;
                });
            });
        }

        function buyPro() {
            // Logic to buy pro. Let's assume it costs 500 Coins or a specific request.
            // Prompt: "BUY PRO FUTURES".
            // We will create a request type 'pro_upgrade'
            if(userData.balanceCoins < 100) {
                return showToast("You need at least 100 TK Coins to upgrade to Pro.", "error");
            }

            if(confirm("Upgrade to Pro for 100 Coins? Benefits: 0% Tax, Unlimited Post.")) {
                db.collection('requests').add({
                    uid: currentUser.uid,
                    type: 'pro_upgrade',
                    amountCoins: 100,
                    status: 'pending',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    showToast("Pro Upgrade Request Sent");
                    loadHistory();
                });
            }
        }

        // --- ADMIN PANEL ---
        function loadAdminData() {
            if(userData.role !== 'admin' && currentUser.email !== 'admin@tkcoin.com') return;

            // Load Requests
            db.collection('requests')
            .where('status', '==', 'pending')
            .orderBy('timestamp', 'desc')
            .onSnapshot(snapshot => {
                const container = document.getElementById('admin-requests');
                container.innerHTML = '';
                if(snapshot.empty) container.innerHTML = '<p style="padding:10px; color:#555;">No pending requests.</p>';

                snapshot.forEach(doc => {
                    const r = doc.data();
                    const reqText = r.type === 'deposit' ? `Deposit: ${r.amountPKR} PKR` 
                                  : r.type === 'withdraw' ? `Withdraw: ${r.amountCoins} TK` 
                                  : `Pro Upgrade`;
                    
                    let actionBtns = '';
                    if(r.type === 'deposit') {
                        actionBtns = `<button class="btn btn-sm" onclick="handleRequest('${doc.id}', 'approve')">Approve</button>`;
                    } else if (r.type === 'withdraw') {
                        // For withdraw, check user balance again
                        actionBtns = `<button class="btn btn-sm" onclick="handleRequest('${doc.id}', 'approve')">Approve</button>`;
                    } else if (r.type === 'pro_upgrade') {
                        actionBtns = `<button class="btn btn-sm" onclick="handleRequest('${doc.id}', 'approve')">Grant Pro</button>`;
                    }
                    
                    actionBtns += ` <button class="btn btn-sm btn-danger" onclick="handleRequest('${doc.id}', 'reject')">Reject</button>`;

                    container.innerHTML += `
                    <div style="background:#2a2a2a; padding:10px; margin-bottom:5px; border-radius:5px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;">
                        <div>
                            <strong>${r.uid}</strong><br>
                            <span style="font-size:0.8rem; color:#aaa;">${reqText}</span>
                        </div>
                        <div style="margin-top:5px;">${actionBtns}</div>
                    </div>`;
                });
            });

            // Load Users
            db.collection('users').limit(10).get().then(snapshot => {
                const container = document.getElementById('admin-users');
                container.innerHTML = '';
                snapshot.forEach(d => {
                    const u = d.data();
                    container.innerHTML += `
                    <div style="padding:8px; border-bottom:1px solid #333;">
                        ${u.name} (${u.email}) - <b>${u.balanceCoins} TK</b> - ${u.isPro ? 'PRO' : 'Normal'}
                    </div>`;
                });
            });
        }

        function saveSettings() {
            const rate = parseFloat(document.getElementById('admin-rate').value);
            const num = document.getElementById('admin-deposit-number').value;
            
            db.collection('settings').doc('global').set({
                rate: rate,
                depositNumber: num
            }).then(() => showToast("Settings Updated"));
        }

        function handleRequest(reqId, action) {
            const reqRef = db.collection('requests').doc(reqId);
            
            reqRef.get().then(doc => {
                const r = doc.data();
                const userRef = db.collection('users').doc(r.uid);

                if(action === 'approve') {
                    if(r.type === 'deposit') {
                        // Give coins
                        const coinsToAdd = r.amountPKR / r.rateAtRequest;
                        userRef.update({
                            balanceCoins: firebase.firestore.FieldValue.increment(coinsToAdd),
                            totalDepositsPKR: firebase.firestore.FieldValue.increment(r.amountPKR)
                        });
                        reqRef.update({ status: 'approved' });
                        showToast("Deposit Approved");
                    } 
                    else if (r.type === 'withdraw') {
                        // Deduct coins
                        // Check sufficient balance (redundant but safe)
                        db.runTransaction(t => {
                            return t.get(userRef).then(udoc => {
                                const bal = udoc.data().balanceCoins;
                                if(bal < r.amountCoins) throw "Insufficient balance";
                                t.update(userRef, { balanceCoins: firebase.firestore.FieldValue.increment(-r.amountCoins) });
                                t.update(reqRef, { status: 'approved' });
                            });
                        }).then(() => showToast("Withdraw Approved"));
                    }
                    else if (r.type === 'pro_upgrade') {
                        userRef.update({
                            balanceCoins: firebase.firestore.FieldValue.increment(-100),
                            isPro: true
                        });
                        reqRef.update({ status: 'approved' });
                        showToast("User Upgraded to Pro");
                    }
                } else {
                    reqRef.update({ status: 'rejected' });
                    showToast("Request Rejected");
                }
            }).catch(err => showToast(err, "error"));
        }

        // --- UTILS ---
        function showToast(msg, type = "success") {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.borderLeftColor = type === "error" ? "var(--danger)" : "var(--primary)";
            toast.innerHTML = `<span>${msg}</span>`;
            
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

    </script>
</body>
</html>
